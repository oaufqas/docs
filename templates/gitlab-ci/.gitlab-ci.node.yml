# Шаблон GitLab CI для Node.js приложения
# Включает: тестирование, сборку, деплой
# Использование: поместить в корень проекта как .gitlab-ci.yml

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Переменные для Docker (должны быть определены в CI/CD Variables)
  # CI_REGISTRY, CI_REGISTRY_USER, CI_REGISTRY_PASSWORD

# Кэширование node_modules
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

# ---- Тестирование ----
test:
  stage: test
  image: node:18-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run lint
    - npm run test
  artifacts:
    reports:
      junit:
        - junit.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# ---- Сборка Docker образа ----
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    # Сборка образа с тегом commit
    - docker build 
        --build-arg NODE_ENV=production 
        --build-arg API_URL=$API_URL 
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA 
        -t $CI_REGISTRY_IMAGE:latest 
        .
    # Пуш образов в registry
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop

# ---- Деплой на staging ----
deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - ssh -o StrictHostKeyChecking=no $STAGING_USER@$STAGING_HOST "
        cd /app &&
        docker-compose pull app &&
        docker-compose up -d app &&
        docker system prune -f
      "
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual  # Ручной запуск

# ---- Деплой на production ----
deploy-production:
  stage: deploy
  image: 
    name: bitnami/kubectl:latest
    entrypoint: [""]
  before_script:
    - mkdir -p $HOME/.kube
    - echo "$KUBE_CONFIG" | base64 -d > $HOME/.kube/config
  script:
    # Обновление образа в Kubernetes deployment
    - kubectl set image deployment/app app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA -n production
    - kubectl rollout status deployment/app -n production
    - kubectl get pods -n production
  environment:
    name: production
    url: https://example.com
  only:
    - main
  when: manual  # Ручной запуск с подтверждением